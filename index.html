<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serverless Expense Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .expense-item {
            transition: all 0.2s ease-in-out;
        }
        .expense-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-900 mb-6 border-b pb-3 flex items-center justify-between">
            ðŸ’° Personal Expense Tracker
            <span id="user-info" class="text-sm font-medium text-gray-500"></span>
        </h1>

        <!-- Add New Expense Form -->
        <section class="bg-indigo-50 p-6 rounded-lg mb-8 shadow-inner">
            <h2 class="text-xl font-semibold text-indigo-800 mb-4">Add New Expense</h2>
            <form id="expense-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    <input type="text" id="description" placeholder="Groceries, Rent, Coffee..." required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700">Amount ($)</label>
                    <input type="number" id="amount" placeholder="0.00" required step="0.01" min="0.01"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="date" value="" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <button type="submit"
                        class="md:col-span-4 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out font-semibold shadow-md">
                    Record Expense
                </button>
            </form>
        </section>

        <!-- Expenses List and Summary -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Summary Card -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-200 sticky top-4">
                    <h2 class="text-xl font-bold text-indigo-600 mb-4">Summary</h2>
                    <div class="flex flex-col space-y-3">
                        <div class="flex justify-between items-center text-lg">
                            <span class="font-medium text-gray-700">Total Expenses:</span>
                            <span id="total-amount" class="font-extrabold text-3xl text-red-600">$0.00</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-4 italic">Displaying all recorded expenses.</p>
                </div>
            </div>

            <!-- List of Expenses -->
            <div class="lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Expense History</h2>
                <div id="expenses-list" class="space-y-3">
                    <p class="text-gray-500" id="loading-message">Loading expenses...</p>
                    <!-- Expenses will be rendered here -->
                </div>
                
                <!-- Error/Status Message Box -->
                <div id="status-message" class="hidden mt-4 p-3 rounded-lg bg-red-100 text-red-700 border border-red-300"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables and Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-expense-tracker-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const EXPENSES_COLLECTION_NAME = "expenses";
        
        // DOM elements
        const form = document.getElementById('expense-form');
        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        const expensesList = document.getElementById('expenses-list');
        const totalAmountSpan = document.getElementById('total-amount');
        const userInfoSpan = document.getElementById('user-info');
        const loadingMessage = document.getElementById('loading-message');
        const statusMessage = document.getElementById('status-message');

        // Set today's date as default
        dateInput.value = new Date().toISOString().split('T')[0];

        // --- Utility Functions ---
        const showStatus = (message, isError = false) => {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');
            statusMessage.className = `mt-4 p-3 rounded-lg border ${isError ? 'bg-red-100 text-red-700 border-red-300' : 'bg-green-100 text-green-700 border-green-300'}`;
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(amount);
        };

        // --- Firebase Initialization and Authentication ---
        const initFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Using default settings.");
                }
                
                // Set Firestore log level for debugging
                setLogLevel('Debug');

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Try to set local persistence (optional, but good practice)
                await setPersistence(auth, browserLocalPersistence).catch(console.error);

                // Listen for Auth State Changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoSpan.textContent = `User ID: ${userId}`;
                        console.log("Authenticated user:", userId);
                        isAuthReady = true;
                        // Start listening for expenses only after auth is ready
                        setupRealtimeListener();
                    } else {
                        // Sign in with custom token or anonymously
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            userInfoSpan.textContent = "Authentication Failed";
                            showStatus(`Error during authentication: ${error.message}`, true);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                showStatus(`Failed to initialize application: ${error.message}`, true);
            }
        };


        // --- Firestore Operations ---
        const getExpensesCollectionRef = () => {
            if (!db || !userId) throw new Error("Database or User ID is not initialized.");
            // Path: /artifacts/{appId}/users/{userId}/expenses
            const userPath = `/artifacts/${appId}/users/${userId}/${EXPENSES_COLLECTION_NAME}`;
            return collection(db, userPath);
        };

        const setupRealtimeListener = () => {
            if (!isAuthReady || !userId) return;

            loadingMessage.classList.remove('hidden');
            expensesList.innerHTML = ''; // Clear previous list

            try {
                const expensesRef = getExpensesCollectionRef();
                // Query to order by timestamp (most recent first)
                const q = query(expensesRef, orderBy("timestamp", "desc"));
                
                // Set up real-time listener
                onSnapshot(q, (snapshot) => {
                    loadingMessage.classList.add('hidden');
                    const expenses = [];
                    let total = 0;

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const expense = {
                            id: doc.id,
                            description: data.description,
                            amount: data.amount,
                            date: data.date,
                            timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                        };
                        expenses.push(expense);
                        total += expense.amount;
                    });

                    renderExpenses(expenses);
                    renderTotal(total);

                    if (expenses.length === 0) {
                        expensesList.innerHTML = '<p class="text-gray-500 italic">No expenses recorded yet. Start tracking!</p>';
                    }
                }, (error) => {
                    console.error("Error fetching expenses in real-time:", error);
                    showStatus(`Failed to load expenses: ${error.message}`, true);
                });

            } catch (error) {
                console.error("Error setting up listener:", error);
                showStatus(`Initialization Error: ${error.message}`, true);
            }
        };

        const addExpense = async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) {
                showStatus("Please wait for user authentication to complete.", true);
                return;
            }

            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const date = dateInput.value;

            if (!description || isNaN(amount) || amount <= 0 || !date) {
                showStatus("Please enter a valid description, amount, and date.", true);
                return;
            }

            try {
                const expensesRef = getExpensesCollectionRef();
                
                await addDoc(expensesRef, {
                    description,
                    amount,
                    date,
                    timestamp: serverTimestamp(), // Use server timestamp for ordering
                });

                form.reset();
                dateInput.value = new Date().toISOString().split('T')[0]; // Reset date to today
                showStatus("Expense recorded successfully!", false);

            } catch (error) {
                console.error("Error adding document:", error);
                showStatus(`Failed to add expense: ${error.message}`, true);
            }
        };

        const deleteExpense = async (id) => {
            if (!isAuthReady || !userId) {
                showStatus("Authentication not ready.", true);
                return;
            }
            
            // Simple confirmation mechanism (not a modal, just logic guard)
            // Note: Using 'confirm()' is generally discouraged in iframes, but used here 
            // as a temporary confirmation mechanism. For a production app, a custom modal UI should be built.
            if (!confirm(`Are you sure you want to delete this expense?`)) {
                return;
            }

            try {
                const docRef = doc(getExpensesCollectionRef(), id);
                await deleteDoc(docRef);
                showStatus("Expense deleted.", false);
            } catch (error) {
                console.error("Error deleting document:", error);
                showStatus(`Failed to delete expense: ${error.message}`, true);
            }
        };


        // --- Rendering Functions ---
        const renderExpenses = (expenses) => {
            expensesList.innerHTML = '';
            
            expenses.forEach(expense => {
                const item = document.createElement('div');
                item.className = 'expense-item flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-100';
                
                const dateText = new Date(expense.date).toLocaleDateString();

                item.innerHTML = `
                    <div class="flex flex-col flex-grow min-w-0">
                        <span class="text-lg font-medium text-gray-900 truncate">${expense.description}</span>
                        <span class="text-sm text-gray-500">${dateText}</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-xl font-bold text-red-600">${formatCurrency(expense.amount)}</span>
                        <button class="delete-btn text-gray-400 hover:text-red-500 transition" data-id="${expense.id}" aria-label="Delete expense">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                expensesList.appendChild(item);
            });

            // Add event listeners for delete buttons
            expensesList.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const expenseId = e.currentTarget.dataset.id;
                    deleteExpense(expenseId);
                });
            });
        };

        const renderTotal = (total) => {
            totalAmountSpan.textContent = formatCurrency(total);
        };


        // --- Event Listeners and Initialization ---
        form.addEventListener('submit', addExpense);

        // Start the application
        window.onload = initFirebase;
    </script>
</body>
</html>
